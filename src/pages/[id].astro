---
import supabase from "../components/SupabaseClient";
import Layout from "../layouts/Layout.astro";
import fs from "fs";
import { Markdown } from "astro-remote";

//export const prerender = true;

const { data: fileNames, error: fileListError } = await supabase.storage
  .from("astro-markdown")
  .list('');

console.log(fileNames)

export function getStaticPaths() {
  let files = [];
  if (fileNames == null){
    return [];
  }
  for (let i = 0; i < fileNames.length; i++) {
    files.push({params: {id: fileNames[i]}}, );
  }
  return fileNames;
}

const { id } = Astro.params;

if (!id) {
  return Astro.redirect("/404");
}

const { data, error } = await supabase.storage
  .from("astro-markdown")
  .download(id + ".md");

if (error) {
  return Astro.redirect("/404");
}

const blob = data;
const buffer = Buffer.from(await blob.arrayBuffer()).toString();

// const file = fs.writeFile('./src/pages/' + id + ".md", buffer.toString(), function (err: any) {
// if (err) {
// return console.log(err);
// }
// });
---
<Layout title={id}>
<Markdown content={buffer}/>
</Layout>